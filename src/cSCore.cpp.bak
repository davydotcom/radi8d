#include"cSCore.h"
#include"getarg.h"
void cSCore::runcore(void)
{
	/*Lets Initialize Some Variables*/
	int lsfd; //Listening File Descriptor
	int nsfd; //Sfd For New Connections
	int ccount; /*Connection Count*/
	int returnval;
	int maxfd;
	char *buffer; //Temporary Message Buffer
	char *charbuffer = new char[1];
	struct sockaddr_in newc;
	fd_set *cset = new fd_set;
	fd_set *master = new fd_set;
	memset(charbuffer,0,1);
	lsfd = Socket->cs_serve(Port);
	int optval = 1;
	setsockopt(lsfd,SOL_SOCKET,SO_REUSEADDR,&optval,sizeof(optval));
	//FD_ZERO(cset);
	FD_ZERO(master);
	FD_ZERO(cset);
	FD_SET(lsfd, master); //Add the listening sfd to the FD set
	maxfd = lsfd;
	ccount = 0;
	sMainUsers *tempuser;
	while(enabled)
	{

		*cset = *master;	
		select(maxfd+1,cset,NULL,NULL,NULL);
		if(FD_ISSET(lsfd, cset)) //If It is a New Connection
		{
			nsfd = accept(lsfd,NULL,(socklen_t *)sizeof(newc));
			ErrorHandler->ProduceError(0,"cSCore::runcore()","New Connection Received");
			if(!UserHandler->AddUser(nsfd,"unsupported"))
			{
				ErrorHandler->ProduceError(0,"cSCore::runcore()","Failed To Add User");
				close(nsfd);
			}
			else
			{
				info("cSCore::runcore()","Adding to FD Set");
			FD_SET(nsfd,master);
			if(nsfd > maxfd)
				maxfd = nsfd;
			}
				
		}
		else
		{
			ErrorHandler->ProduceError(0,"cSCore::runcore()","Data Received");
			tempuser = UserHandler->GetUser(0);
			//ErrorHandler->ProduceError(0,"cSCore::runcore()","UserPtr Caught");
			while(tempuser != NULL)
			{
				//ErrorHandler->ProduceError(0,"cSCore::runcore()","looping list");
				/*A User wants to send something*/
				if(FD_ISSET(tempuser->sfd,cset) && tempuser->sfd != lsfd)
				{
					nsfd = tempuser->sfd;
					ErrorHandler->ProduceError(0,"cSCore::runcore()","reading data");
					returnval = Socket->cs_read(nsfd,charbuffer,1);
					//printf("Buffer value: %d\n",int(charbuffer[0]));
					//Check For Disconnects
					if(returnval == 0)
					{
						
						
						ChannelHandler->UserDisconnected(nsfd);
						info("cSCore::runcore()","User Disconnected From Channels");
						UserHandler->RemoveUser(nsfd);
						info("cSCore::runcore()","User Disconnected");
						
						close(nsfd);
						FD_CLR(nsfd,master);
						if(UserHandler->numusers == 0)
						{
							FD_ZERO(master);
							FD_SET(lsfd,master);
						}
						break;
						
					}
					else
					{
						if(int(charbuffer[0]) == -1) //Byte 255
						{
							this->parsecmd(nsfd,tempuser->UserBuffer->buffer);
							(tempuser->UserBuffer->done) = true;
						}
						else if((tempuser->UserBuffer->strsize) < ((tempuser->UserBuffer->buffersize) - 1))
						{
							tempuser->UserBuffer->buffer[(tempuser->UserBuffer->strsize)] = charbuffer[0];
							(tempuser->UserBuffer->strsize)++;
						}
						else if((tempuser->UserBuffer->buffersize) < 512)
						{
							(tempuser->UserBuffer->buffersize) += 5;
							buffer = new char[(tempuser->UserBuffer->buffersize)];
							memset(buffer,0,(tempuser->UserBuffer->buffersize));
							char *temp = tempuser->UserBuffer->buffer;
							strcpy(buffer,temp);
							buffer[(tempuser->UserBuffer->strsize)] = charbuffer[0];
							(tempuser->UserBuffer->strsize)++;
							tempuser->UserBuffer->buffer = buffer;
							delete [] temp;
							
						}
						else
						{
							(tempuser->UserBuffer->done) = true;
						}
						
						if((tempuser->UserBuffer->done) == true)
						{
							char *temp = tempuser->UserBuffer->buffer;
							tempuser->UserBuffer->buffer = new char[10];
							memset(tempuser->UserBuffer->buffer,0,10);
							(tempuser->UserBuffer->strsize) = 0;
							(tempuser->UserBuffer->buffersize) = 10;
							(tempuser->UserBuffer->done) = false;
							delete [] temp;
						}
					
					
					}
					break;
				}
				tempuser=tempuser->next;
			}

		}
		
	}
	close(lsfd);
	delete master;
	delete cset;
	delete [] buffer;
}
void cSCore::parsecmd(int usersfd,char *buffer)
{


	if(buffer[0] == '!')
	{
		char *cmd  = GetArg(0,buffer,':');
		info("Command From parsecmd",cmd);
		if(cmd != NULL)
		{
			if(!strcmp(cmd,"!name")) //Name Change Requested
			{
				ChangeName(usersfd,buffer);
			}
			
			else if(!strcmp(UserHandler->GetUserName(usersfd),"unverified"))
			{
				info("cSCore::parsecmd()","Unverified User Attempted Command\n");
			}
			else if(!strcmp(cmd,"!jnchn")) //Join Channel Requested
			{
				JoinChannel(usersfd,buffer);	
			}
			else if(!strcmp(cmd,"!lvchn")) //Leave Channel Requested
			{
				LeaveChannel(usersfd,buffer);
			}
			else if(!strcmp(cmd,"!msg")) //Message Transmit Requested
			{
				Message(usersfd,buffer);
			}
			else if(!strcmp(cmd,"!emote")) //Emote Transmit Requested
			{
				Emote(usersfd,buffer);
			}
			else if(!strcmp(cmd,"!topic"))
			{
				GetTopic(usersfd,buffer);
			}
			else if(!strcmp(cmd,"!settopic"))
			{
				SetTopic(usersfd,buffer);
			}
			

			else if(!strcmp(cmd,"!chanlist")) //Name Change Requested
			{
				ChannelList(usersfd);
			}
			else if(!strcmp(cmd,"!userlist")) //Name Change Requested
			{
				UserList(usersfd,buffer);
			}
			else if(!strcmp(cmd,"!motd"))
			{
				SendMOTD(usersfd);
			}
			delete [] cmd;
		}
	}
}

void cSCore::JoinChannel(int usersfd,char *buffer)
{
	int returnval;

	char *ChName = GetArg(1,buffer,':');
	printf("ChName = %s\n",ChName);
	char *Password = GetArg(2,buffer,':');
	if(ChName != NULL)
	{
		if(ChannelHandler->IsAChannel(ChName) == -1)
		{
			info("cSCore::JoinChannel","Creating Channel");
			if(!ChannelHandler->CreateChannel(ChName,Password,NULL,0,false,false))
			{
				Socket->cs_write(usersfd,"!err:jnchn:Unable To Create",27);
				delete [] ChName;
				if(Password != NULL)
					delete [] Password;
				return;
				
			}
			
		}
		info("cSCore::JoinChannel","Joining Channel");
		returnval = ChannelHandler->JoinChannel(usersfd,ChName,Password);
		info("cSCore::JoinChannel","Channel Join Called");
		switch(returnval)
		{
		case 0: //Success
			Socket->cs_write(usersfd,"!apr:jnchn",10);		
			break;
		case -1: //Channel Does Not Exist
			Socket->cs_write(usersfd,"!err:jnchn:Failed To Create Channel",35);		
			break;
		case -2: //User Already In Channel
			Socket->cs_write(usersfd,"!err:jnchn:Already In Channel",29);		
			break;
		case -3:// Invalid Password
			Socket->cs_write(usersfd,"!err:jnchn:Invalid Password",27);		
			break;
		case -4://Unknown Error (Should Never Happen)
			Socket->cs_write(usersfd,"!err:jnchn:Unknown Error",24);		
			break;
		case -5://Reserved Users Only
			Socket->cs_write(usersfd,"!err:jnchn:This Channel Is For Reserved Users Only",50);		
			break;
		};
		if(Password != NULL)
			delete [] Password;
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:lvchn:Channel Not Specified",32);
}
void cSCore::LeaveChannel(int usersfd,char *buffer)
{
bool returnval;
	char *ChName = GetArg(1,buffer,':');
	printf("ChName = %s\n",ChName);
	
	if(ChName != NULL)
	{

		returnval = ChannelHandler->LeaveChannel(usersfd,ChName);
		if(!returnval)
			Socket->cs_write(usersfd,"!err:lvchn:You Are Not In That Channel",38);
		else
			Socket->cs_write(usersfd,"!apr:lvchn",10);
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:lvchn:Channel Not Specified",32);
	
}
void cSCore::Message(int usersfd,char *buffer)
{
bool returnval;
	char *ChName = GetArg(1,buffer,':');
	printf("ChName = %s\n",ChName);
	
	if(ChName != NULL)
	{
		if(!strcmp(ChName,"user"))
		{
			char *UserName = GetArg(2,buffer,':');
			if(UserName != NULL)
			{
				char *TheMsg = GetArg(3,buffer,':');
				if(TheMsg != NULL)
				{
				
				int *TheirSFD = new int;
				*TheirSFD = UserHandler->GetSFD(UserName);
				if(*TheirSFD == -1)
				{
					Socket->cs_write(usersfd,"!err:msg:User Does Not Exist",28);
					delete [] TheMsg;
					delete TheirSFD;
				}
				else
				{
				char *FromUser = UserHandler->GetUserName(usersfd);
				info("cSCore::Message","Declaring Buffer");
				char *buffer2 = new char[44 + strlen(TheMsg)];
				memset(buffer2,0,44 + strlen(TheMsg));
				info("cSCore::Message","Buffer Declared");
				sprintf(buffer2,"!usrmsg:user:%s:%s",FromUser,TheMsg);
				Socket->cs_write(*TheirSFD,buffer2,strlen(buffer2));
				delete [] buffer2;
				delete [] TheMsg;
				delete TheirSFD;
				}
				}
				else
				{
					Socket->cs_write(usersfd,"!err:msg:No Message",19);	
				}
				delete[]UserName;
			}
			else
				Socket->cs_write(usersfd,"!err:msg:UserName Not Specified",31);
		}
		else
		{
			char *TheMsg = GetArg(2,buffer,':');
			if(TheMsg != NULL)
			{
				char *FromUser = UserHandler->GetUserName(usersfd);
				
				
				
				
				char *buffer2 = new char[66 + strlen(TheMsg)];
				
				memset(buffer2,0,66 + strlen(TheMsg));
				
				sprintf(buffer2,"!usrmsg:%s:%s:%s",ChName,FromUser,TheMsg);	
				
				returnval = ChannelHandler->SendToChannel(usersfd,ChName,buffer2);
				
				if(!returnval)
					Socket->cs_write(usersfd,"!err:msg:Failed To Send To Channel",34);
				delete [] buffer2;
				delete [] TheMsg;
			}
			else
				Socket->cs_write(usersfd,"!err:msg:No Message",19);	
		}
		
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:msg:Channel Not Specified",30);
}
void cSCore::ChangeName(int usersfd,char *buffer)
{
	int returnval;
	char *NewName = GetArg(1,buffer,':');
	
	
	if(NewName != NULL)
	{
		char *Password = GetArg(2,buffer,':');
		char *Temp = UserHandler->GetUserName(usersfd);
		char *OldName = new char[strlen(Temp)];
		memset(OldName,0,strlen(Temp));
		strcpy(OldName,Temp);
		returnval = UserHandler->SetName(usersfd,NewName,Password);
		switch(returnval)
		{
		case 0:
			Socket->cs_write(usersfd,"!apr:name",9);
			ChannelHandler->UserNameChange(usersfd,OldName);
			break;
		case -1:
			Socket->cs_write(usersfd,"!err:name:New Name Not Specified",32);
			break;
		case -2:
			Socket->cs_write(usersfd,"!err:name:New Name Too Long",27);
			break;
		case -3:
			Socket->cs_write(usersfd,"!err:name:Unknown Error",23);
			break;
		case -4:
			Socket->cs_write(usersfd,"!err:name:Invalid Password",26);
			break;
		case -5: 
			Socket->cs_write(usersfd,"!err:name:User Already Connected",32);
			break;
		};
		delete [] OldName;
		delete [] NewName;
		delete [] Password;
	}
	else
		Socket->cs_write(usersfd,"!err:name:New Name Not Specified",32);
}
void cSCore::Emote(int usersfd,char *buffer)
{
bool returnval;
	char *ChName = GetArg(1,buffer,':');
	
	
	if(ChName != NULL)
	{
		if(!strcmp(ChName,"user"))
		{
			char *UserName = GetArg(2,buffer,':');
			if(UserName != NULL)
			{
				char *TheMsg = GetArg(3,buffer,':');
				if(TheMsg != NULL)
				{
				
				int *TheirSFD = new int;
				*TheirSFD = UserHandler->GetSFD(UserName);
				if(*TheirSFD == -1)
				{
					Socket->cs_write(usersfd,"!err:emote:User Does Not Exist",30);
					delete [] TheMsg;
					delete TheirSFD;
				}
				else
				{
				char *FromUser = UserHandler->GetUserName(usersfd);
				char *buffer2 = new char[44 + strlen(TheMsg)];
				memset(buffer2,0,44 + strlen(TheMsg));
				sprintf(buffer2,"!usremt:user:%s:%s",FromUser,TheMsg);
				Socket->cs_write(*TheirSFD,buffer2,strlen(buffer2));
				delete [] buffer2;
				delete [] TheMsg;
				delete TheirSFD;
				}
				}
				else
				{
					Socket->cs_write(usersfd,"!err:emote:No Message",21);	
				}
				delete[]UserName;
			}
			else
				Socket->cs_write(usersfd,"!err:emote:UserName Not Specified",33);
		}
		else
		{
			char *TheMsg = GetArg(2,buffer,':');
			if(TheMsg != NULL)
			{
				char *FromUser = UserHandler->GetUserName(usersfd);
				
				
				
				
				char *buffer2 = new char[66 + strlen(TheMsg)];
				
				memset(buffer2,0,66 + strlen(TheMsg));
				
				sprintf(buffer2,"!usremt:%s:%s:%s",ChName,FromUser,TheMsg);	
				
				returnval = ChannelHandler->SendToChannel(usersfd,ChName,buffer2);
				
				if(!returnval)
					Socket->cs_write(usersfd,"!err:emote:Failed To Send To Channel",36);
				delete [] buffer2;
				delete [] TheMsg;
			}
			else
				Socket->cs_write(usersfd,"!err:emote:No Message",21);	
		}
		
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:emote:Channel Not Specified",32);
}
void cSCore::SendMOTD(int usersfd)
{
	info("cSCore::SendMOTD","Sending MOTD to Client!");
	FILE *MOTDFile = NULL;
	MOTDFile = fopen("radi8d.motd","r");
	if(MOTDFile == NULL)
	{
		Socket->cs_write(usersfd,"!motd:No Motd Set",17);
		return;
	}
	char *outputbuffer = new char[255];
	while(!feof(MOTDFile))
	{
		memset(outputbuffer,0,255);
		strcpy(outputbuffer,"!motd:");
		fgets(&outputbuffer[6],128,MOTDFile);
		Socket->cs_write(usersfd,outputbuffer,strlen(outputbuffer));
	}
	delete [] outputbuffer;
	fclose(MOTDFile);
	
}
void cSCore::ChannelList(int usersfd)
{
	char *ChannelName;
	char *Topic;
	int *NumberUsers = new int;
	
	for(int x=0;;x++)
	{
		ChannelName = ChannelHandler->GetChannelList(x);
		if(ChannelName == NULL)
			break;
		Topic = ChannelHandler->GetTopic(ChannelName);
		*NumberUsers = ChannelHandler->GetNumberUsers(ChannelName);
		if(Topic == NULL)
		{
			char *buffer = new char[50];
			memset(buffer,0,50);
			sprintf(buffer,"!chanadd:%s:%d",ChannelName,*NumberUsers);
			Socket->cs_write(usersfd,buffer,strlen(buffer));
			delete [] buffer;
		}
		else
		{
		char *buffer = new char[50 + strlen(Topic)];
			memset(buffer,0,50 + strlen(Topic));
			sprintf(buffer,"!chanadd:%s:%d:%s",ChannelName,*NumberUsers,Topic);
			Socket->cs_write(usersfd,buffer,strlen(buffer));
			delete [] buffer;
		}
		
	}
	delete NumberUsers;
}
void cSCore::GetTopic(int usersfd,char *buffer)
{
	char *ChName = GetArg(1,buffer,':');
	if(ChName != NULL)
	{
		char *Topic = ChannelHandler->GetTopic(ChName); //Do not delete this var, it is just a pointer to a struct object
		if(Topic == NULL)
		{

		char *TopicData = new char[strlen(ChName)+7+8];
		memset(TopicData,0,strlen(ChName)+7+8);
		sprintf(TopicData,"!topic:%s:No Topic",ChName);
		Socket->cs_write(usersfd,TopicData,strlen(TopicData));
		delete [] TopicData;
		}
		else
		{
			char *TopicData = new char[strlen(ChName)+7+strlen(Topic)];
			memset(TopicData,0,strlen(ChName)+7+strlen(Topic));
			sprintf(TopicData,"!topic:%s:%s",ChName,Topic);
			Socket->cs_write(usersfd,TopicData,strlen(TopicData));
			delete [] TopicData;
		}
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:topic:Channel Not Specified",32);
}
void cSCore::SetTopic(int usersfd,char *buffer)
{
	info("cSCore::SetTopic","Entering Function");
	char *ChName = GetArg(1,buffer,':');
	if(ChName != NULL)
	{
		
		char *Topic = GetArg(2,buffer,':');
		if(Topic == NULL)
		{
			Socket->cs_write(usersfd,"!err:settopic:No Topic Specified",32);

		
		}
		else
		{
			if(ChannelHandler->SetTopic(usersfd,ChName,Topic))
			{
				info("cSCore::SetTopic","Topic Set Succeeded");
				char *TopicSet = new char[288];
				memset(TopicSet,0,288);
				sprintf(TopicSet,"!topic:%s:%s",ChName,Topic);
				ChannelHandler->SendToChannel(-1,ChName,TopicSet);
				delete [] TopicSet;
			}
			else
			{
				Socket->cs_write(usersfd,"!err:settopic:Unable To Set The Topic. You May Not Have Sufficient Privilages",77);
				info("cSCore::SetTopic","Topic Failed to be set");	
			}
			delete [] Topic;
		}
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:settopic:Channel Name Not Specified",40);
}
void cSCore::UserList(int usersfd, char *buffer)
{

	char *ChName = GetArg(1,buffer,':');
	
	
	if(ChName != NULL)
	{
		sUserList *TempUser = ChannelHandler->GetUser(0,ChName);
		for(;;)
		{
			if(TempUser == NULL)
				break;
			
				
			char *UserName = UserHandler->GetUserName(TempUser->sfd);
			char *buffer = new char[67];
			memset(buffer,0,67);
			sprintf(buffer,"!usrjoind:%s:%s:%d:%d",ChName,UserName,TempUser->permissions,UserHandler->GetAcceptVoice(TempUser->sfd));
			Socket->cs_write(usersfd,buffer,strlen(buffer));
			//!usrjoind:channel:username:permissions:allowvoice
			delete [] buffer;
			TempUser = TempUser->next;
		}
		delete [] ChName;
	}
	else
		Socket->cs_write(usersfd,"!err:userlist:Channel Name Not Specified",40);
}

